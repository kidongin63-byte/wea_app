import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from io import StringIO

# -----------------------------------------------------------------------------
# 1. ë°ì´í„° ì¤€ë¹„ (ì´ë¯¸ì§€ì˜ ë°ì´í„°ë¥¼ CSV ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¡œë“œ)
# -----------------------------------------------------------------------------
csv_data = """
ì—°ë„,ì‹œë„,65-69ì„¸,70-74ì„¸,75-79ì„¸,80-84ì„¸,85ì„¸ì´ìƒ
2022,ì„œìš¸ Seoul,88603,69505,57712,45157,30904
2022,ë¶€ì‚° Busan,46276,37456,29862,23921,14433
2022,ëŒ€êµ¬ Daegu,27586,22314,17546,15726,10597
2022,ì¸ì²œ Incheon,28165,20192,16766,13504,9779
2022,ê´‘ì£¼ Gwangju,13603,11203,9508,8004,5428
2022,ëŒ€ì „ Daejeon,14870,11012,8847,7479,5384
2022,ìš¸ì‚° Ulsan,11156,8111,5909,4405,2703
2022,ì„¸ì¢… Sejong,2140,1512,1207,1059,871
2022,ê²½ê¸° Gyeonggi,108953,78302,65344,53678,37515
2022,ê°•ì› Gangwon,22311,16371,15769,14517,10519
2022,ì¶©ë¶ Chungbuk,19626,14255,13323,13072,10043
2022,ì¶©ë‚¨ Chungnam,23503,19625,17759,17977,15804
2022,ì „ë¶ Jeonbuk,21827,19897,19122,19183,15577
2022,ì „ë‚¨ Jeonnam,22949,22493,23555,24850,19456
2022,ê²½ë¶ Gyeongbuk,36257,30793,27528,29021,23196
2022,ê²½ë‚¨ Gyeongnam,41123,32549,28283,26902,20717
2022,ì œì£¼ Jeju,6500,4477,3822,3342,3170
2023,ì„œìš¸ Seoul,94163,71418,59669,49167,34782
2023,ë¶€ì‚° Busan,48702,38673,31046,26224,16013
2023,ëŒ€êµ¬ Daegu,28814,23476,17996,17125,11776
2023,ì¸ì²œ Incheon,31145,21167,17681,14729,10906
2023,ê´‘ì£¼ Gwangju,14925,11321,9799,8625,6058
2023,ëŒ€ì „ Daejeon,16091,11505,9170,8066,6028
2023,ìš¸ì‚° Ulsan,12043,8632,6334,4954,2969
2023,ì„¸ì¢… Sejong,2392,1651,1273,1155,966
2023,ê²½ê¸° Gyeonggi,120837,83067,69006,58256,42128
2023,ê°•ì› Gangwon,24488,17181,16050,15225,11836
2023,ì¶©ë¶ Chungbuk,21494,15010,13487,13898,11121
2023,ì¶©ë‚¨ Chungnam,25590,20083,18145,18766,17329
2023,ì „ë¶ Jeonbuk,23513,19745,19399,20131,16923
2023,ì „ë‚¨ Jeonnam,24683,22264,23262,26103,21121
2023,ê²½ë¶ Gyeongbuk,37942,32011,27541,30996,25181
2023,ê²½ë‚¨ Gyeongnam,44155,33601,29426,28570,22468
2023,ì œì£¼ Jeju,7110,4570,4012,3491,3490
"""

# ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
@st.cache_data
def load_data():
    df = pd.read_csv(StringIO(csv_data))
    # 'ì´ ê³ ë ¹ ì¸êµ¬' ì»¬ëŸ¼ ìƒì„± (ëª¨ë“  ì—°ë ¹ëŒ€ í•©ê³„)
    age_cols = ['65-69ì„¸', '70-74ì„¸', '75-79ì„¸', '80-84ì„¸', '85ì„¸ì´ìƒ']
    df['ì´ ê³ ë ¹ ì¸êµ¬'] = df[age_cols].sum(axis=1)
    
    # ì‹œë„ëª… ê°„ì†Œí™” (ì˜ˆ: 'ì„œìš¸ Seoul' -> 'ì„œìš¸')
    df['ì‹œë„_ì•½ì¹­'] = df['ì‹œë„'].apply(lambda x: x.split(' ')[0])
    return df, age_cols

df, age_cols = load_data()

# -----------------------------------------------------------------------------
# 2. Streamlit ë ˆì´ì•„ì›ƒ ì„¤ì •
# -----------------------------------------------------------------------------
st.set_page_config(page_title="ê³ ë ¹ ì¸êµ¬ ë¶„ì„ ëŒ€ì‹œë³´ë“œ", layout="wide")

st.title("ğŸ“Š ì‹œë„ë³„ ê³ ë ¹ ì¸êµ¬(65ì„¸ ì´ìƒ) ë¶„ì„ ëŒ€ì‹œë³´ë“œ")
st.markdown("2022ë…„ ë° 2023ë…„ ì‹œë„ë³„, ì—°ë ¹ëŒ€ë³„ ê³ ë ¹ ì¸êµ¬ ë°ì´í„°ë¥¼ ë¶„ì„í•œ ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.")

# ì‚¬ì´ë“œë°” ì„¤ì •
st.sidebar.header("í•„í„° ì„¤ì •")
selected_year = st.sidebar.selectbox("ë¶„ì„ ì—°ë„ ì„ íƒ", df['ì—°ë„'].unique())
selected_regions = st.sidebar.multiselect("ë¹„êµí•  ì§€ì—­ ì„ íƒ", df['ì‹œë„_ì•½ì¹­'].unique(), default=df['ì‹œë„_ì•½ì¹­'].unique())

# ë°ì´í„° í•„í„°ë§
filtered_df = df[(df['ì—°ë„'] == selected_year) & (df['ì‹œë„_ì•½ì¹­'].isin(selected_regions))]

# KPI ì§€í‘œ í‘œì‹œ (ë§¨ ìœ„)
total_pop = filtered_df['ì´ ê³ ë ¹ ì¸êµ¬'].sum()
avg_pop = filtered_df['ì´ ê³ ë ¹ ì¸êµ¬'].mean()
max_region = filtered_df.loc[filtered_df['ì´ ê³ ë ¹ ì¸êµ¬'].idxmax(), 'ì‹œë„_ì•½ì¹­']

col1, col2, col3 = st.columns(3)
col1.metric("ì„ íƒ ì§€ì—­ ì´ ê³ ë ¹ ì¸êµ¬", f"{total_pop:,.0f}ëª…")
col2.metric("ì§€ì—­ í‰ê·  ê³ ë ¹ ì¸êµ¬", f"{avg_pop:,.0f}ëª…")
col3.metric("ìµœë‹¤ ì¸êµ¬ ì§€ì—­", max_region)

st.divider()

# -----------------------------------------------------------------------------
# 3. ë„¤ ê°€ì§€ ë¶„ì„ ì‹œê°í™”
# -----------------------------------------------------------------------------

# [ë¶„ì„ 1] ì§€ì—­ë³„ ì´ ê³ ë ¹ ì¸êµ¬ ë¹„êµ (Bar Chart)
st.subheader(f"1. {selected_year}ë…„ ì§€ì—­ë³„ ì´ ê³ ë ¹ ì¸êµ¬ ìˆœìœ„")
fig1 = px.bar(
    filtered_df.sort_values('ì´ ê³ ë ¹ ì¸êµ¬', ascending=False),
    x='ì‹œë„_ì•½ì¹­', y='ì´ ê³ ë ¹ ì¸êµ¬',
    color='ì´ ê³ ë ¹ ì¸êµ¬',
    text_auto='.2s',
    color_continuous_scale='Blues',
    title=f"{selected_year}ë…„ ì§€ì—­ë³„ ê³ ë ¹ ì¸êµ¬ ê·œëª¨"
)
st.plotly_chart(fig1, use_container_width=True)

# [ë¶„ì„ 2] ì—°ë„ë³„ ì¸êµ¬ ë³€í™” ë¹„êµ (Grouped Bar Chart)
# ì „ì²´ ë°ì´í„°ì—ì„œ ì„ íƒëœ ì§€ì—­ë§Œ í•„í„°ë§í•˜ì—¬ ì—°ë„ë³„ ë¹„êµ
st.subheader("2. 2022ë…„ vs 2023ë…„ ì¸êµ¬ ë³€í™” ë¹„êµ")
compare_df = df[df['ì‹œë„_ì•½ì¹­'].isin(selected_regions)]
fig2 = px.bar(
    compare_df,
    x='ì‹œë„_ì•½ì¹­', y='ì´ ê³ ë ¹ ì¸êµ¬',
    color='ì—°ë„',
    barmode='group',
    text_auto='.2s',
    title="ì—°ë„ë³„ ì¸êµ¬ ì¦ê° í˜„í™©",
    color_discrete_map={2022: '#bdc3c7', 2023: '#3498db'} # íšŒìƒ‰(ê³¼ê±°), íŒŒë€ìƒ‰(ìµœì‹ )
)
st.plotly_chart(fig2, use_container_width=True)

row2_col1, row2_col2 = st.columns(2)

# [ë¶„ì„ 3] ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ êµ¬ì„±ë¹„ (Pie Chart / Donut Chart)
with row2_col1:
    st.subheader("3. ì§€ì—­ë³„ ì—°ë ¹ëŒ€ êµ¬ì„±ë¹„")
    target_region = st.selectbox("êµ¬ì„±ë¹„ë¥¼ í™•ì¸í•  ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”:", selected_regions)
    
    # ì„ íƒëœ ì§€ì—­ì˜ ì—°ë ¹ëŒ€ ë°ì´í„° ì¶”ì¶œ
    region_data = filtered_df[filtered_df['ì‹œë„_ì•½ì¹­'] == target_region].iloc[0]
    pie_data = pd.DataFrame({
        'ì—°ë ¹ëŒ€': age_cols,
        'ì¸êµ¬ìˆ˜': [region_data[col] for col in age_cols]
    })
    
    fig3 = px.pie(
        pie_data, values='ì¸êµ¬ìˆ˜', names='ì—°ë ¹ëŒ€',
        hole=0.4, # ë„ë„› ì°¨íŠ¸
        title=f"{target_region}ì˜ ê³ ë ¹ ì¸êµ¬ ì—°ë ¹ëŒ€ë³„ ë¹„ì¤‘"
    )
    st.plotly_chart(fig3, use_container_width=True)

# [ë¶„ì„ 4] ì§€ì—­ vs ì—°ë ¹ëŒ€ íˆíŠ¸ë§µ (Heatmap)
with row2_col2:
    st.subheader("4. ì§€ì—­ ë° ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë°€ì§‘ë„ (Heatmap)")
    
    # íˆíŠ¸ë§µì„ ìœ„í•œ ë°ì´í„° ì¬êµ¬ì¡°í™” (Melt)
    heatmap_data = filtered_df.melt(
        id_vars=['ì‹œë„_ì•½ì¹­'], 
        value_vars=age_cols, 
        var_name='ì—°ë ¹ëŒ€', 
        value_name='ì¸êµ¬ìˆ˜'
    )
    
    fig4 = px.density_heatmap(
        heatmap_data, 
        x='ì—°ë ¹ëŒ€', y='ì‹œë„_ì•½ì¹­', z='ì¸êµ¬ìˆ˜',
        color_continuous_scale='OrRd', # ë¶‰ì€ìƒ‰ ê³„ì—´
        title=f"{selected_year}ë…„ ì¸êµ¬ ë°€ì§‘ë„ íˆíŠ¸ë§µ",
        text_auto=True
    )
    st.plotly_chart(fig4, use_container_width=True)

# -----------------------------------------------------------------------------
# 4. ë°ì´í„° ì›ë³¸ ë³´ê¸°
# -----------------------------------------------------------------------------
with st.expander("ì›ë³¸ ë°ì´í„° ë³´ê¸°"):
    st.dataframe(filtered_df)